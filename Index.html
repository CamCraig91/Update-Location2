<html>
  <head>
    <meta charset="UTF-8">
    <title>Updating Your Record...</title>
    <style>
      body { font-family: Arial, sans-serif; text-align: center; padding-top: 2em; }
    </style>
  </head>
  <body>
    <h1>Acquiring Your Location...</h1>
    <p id="status">Please wait while we update your record.</p>
    <script>
      // Parse the recordId from the URL's query parameters.
      const params = new URLSearchParams(window.location.search);
      const recordId = params.get('recordId');

      if (!recordId) {
        document.getElementById('status').innerText = 'Error: Record ID missing.';
      } else if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;

            // Set the Method:CRM API update endpoint URL.
            const updateEndpoint = 'https://api.methodcrm.com/records/update';

            // Debugging fetch script starts here
            fetch(updateEndpoint, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'x-api-key': 'NjdkYzNiNmMxODQwNmI5YTI3NTdlOWVhLkJEQjFCNjNGMkY3QzQ1M0ZBMTE0Q0JBOTU2QzA0NjY4'
              },
              body: JSON.stringify({
                table: 'CustomSchedule',
                recordId: recordId,
                fields: {
                  ActualStartLatitude: latitude,
                  ActualStartLongtitude: longitude
                }
              })
            })
            .then(response => {
              // Convert response to JSON and log for debugging
              return response.json().then(data => {
                console.log('API Response:', data); // Log the full API response for debugging
                if (!response.ok) {
                  throw new Error(`HTTP ${response.status}: ${data.message}`);
                }
                return data;
              });
            })
            .then(data => {
              console.log('Record updated successfully:', data);
              window.close(); // Close the window automatically on success
            })
            .catch(error => {
              console.error('Error updating record:', error);
              document.getElementById('status').innerText = 'Error updating record.';
            });
            // Debugging fetch script ends here
          },
          (error) => {
            console.error('Error obtaining location:', error);
            document.getElementById('status').innerText = 'Error obtaining location: ' + error.message;
          },
          {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
          }
        );
      } else {
        document.getElementById('status').innerText = 'Geolocation is not supported by your browser.';
      }
    </script>
  </body>
</html>
